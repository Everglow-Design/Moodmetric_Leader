<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <title>Bruger- & Adgangsstyring</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="dashboard-container" style="position: relative;">
        <button class="menu-btn" id="menuBtn" aria-label="Åbn menu">☰</button>
        <nav class="side-menu" id="sideMenu">
            <a href="ledelse.html">Dashboard</a>
            <a href="analyse.html">Analyse</a>
            <a href="segmentering.html">Segmentering</a>
            <a href="advarsler.html">Advarsler</a>
            <a href="brugere.html">Bruger-adgang</a>
            <a href="rapporter.html">Rapporter</a>
            <a href="index.html">Log ud</a>
        </nav>
        <h1>Bruger- & Adgangsstyring</h1>
        <section class="section">
                    <section class="section">
                        <h2>Opret ny gruppe/team</h2>
                        <form id="createTeamForm" style="margin-bottom: 18px;">
                            <input type="text" id="teamName" placeholder="Teamnavn" required style="padding: 6px;">
                            <button type="submit">Opret gruppe/team</button>
                        </form>
                        <div id="teamCreateResult"></div>
            <h2>Opret medarbejder-login</h2>
            <form id="createUserForm" style="margin-bottom: 18px;">
                <label for="userTeam">Vælg gruppe/team:</label>
                <select id="userTeam" required style="padding: 6px;"></select>
                <label for="userCount">Antal medarbejdere:</label>
                <input type="number" id="userCount" min="1" max="100" value="1" required style="padding: 6px; width: 60px;">
                <button type="submit">Opret brugere</button>
            </form>
            <div id="inviteResult"></div>
        </section>
        <section class="section">
            <h2>Brugere</h2>
            <div id="userTable"></div>
        </section>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
    // Supabase setup
    const SUPABASE_URL = 'https://rwksvrxfsjfdikckwmzq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3a3N2cnhmc2pmZGlrY2t3bXpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczOTY5MTksImV4cCI6MjA4Mjk3MjkxOX0.rddfbx0API_R62uLWJdM5QCMmqIwc-9b6XpgfNsbsOk';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Hent teams til dropdown
    async function loadTeamsDropdown() {
        const { data: teams } = await _supabase.from('TEAMS').select('id, navn');
        const select = document.getElementById('userTeam');
        select.innerHTML = '';
        if (teams && teams.length) {
            teams.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.textContent = t.navn;
                select.appendChild(opt);
            });
        }
    }
    document.addEventListener('DOMContentLoaded', loadTeamsDropdown);

    // Generér brugernavn og password
    function generateUsername(teamName, idx) {
        // Simpelt brugernavn: teamnavn + løbenummer
        return (
            teamName.replace(/[^a-zA-Z0-9]/g, '').toLowerCase().substring(0,8) + (100+idx)
        );
    }
    function generatePassword() {
        return Math.random().toString(36).slice(-8) + Math.floor(100+Math.random()*900);
    }

    // Opret flere brugere med autogenereret brugernavn/password
    document.getElementById('createUserForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const teamId = document.getElementById('userTeam').value;
        const antal = parseInt(document.getElementById('userCount').value, 10);
        if (!teamId || !antal || antal < 1) return;
        // Hent teamnavn
        const { data: team } = await _supabase.from('TEAMS').select('navn').eq('id', teamId).single();
        if (!team) return;
        let resultList = '<strong>Oprettede brugere:</strong><br><table><tr><th>Brugernavn</th><th>Password</th></tr>';
        for (let i = 0; i < antal; i++) {
            const username = generateUsername(team.navn, i);
            const password = generatePassword();
            // Opret bruger i auth (kun brugernavn og password)
            let { data, error } = await _supabase.auth.signUp({
                email: username + '@noemail.local', // dummy email, da supabase kræver email
                password: password,
                options: {
                    data: { brugernavn: username, team_id: teamId, rolle: 'medarbejder' }
                }
            });
            if (error) {
                resultList += `<tr><td colspan="2">Fejl for ${username}: ${error.message}</td></tr>`;
                continue;
            }
            const userId = data.user?.id || data.user?.user?.id;
            if (userId) {
                await _supabase.from('PROFILES_EMPLOYEE').insert({
                    id: userId,
                    brugernavn: username,
                    team_id: teamId,
                    rolle: 'medarbejder',
                    aktiv: true,
                    temp_password: password
                });
            }
            resultList += `<tr><td>${username}</td><td>${password}</td></tr>`;
        }
        resultList += '</table>';
        document.getElementById('inviteResult').innerHTML = resultList;
        document.getElementById('createUserForm').reset();
        loadUsers();
    });

    // Hent teams til flytning
    async function getTeams() {
        const { data } = await _supabase.from('TEAMS').select('id, navn');
        return data || [];
    }

    // Hent og vis brugere
    async function loadUsers() {
        const { data: users } = await _supabase.from('PROFILES_EMPLOYEE').select('*');
        const teams = await getTeams();
        const teamMap = {};
        teams.forEach(t => teamMap[t.id] = t.navn);
        // Vis alle brugere, uanset rolle
        let html = `<div style="max-height:340px;overflow-y:auto;"><table style="width:100%;max-width:700px;"><tr><th>Brugernavn</th><th>Rolle</th><th>Team</th><th>Status</th><th>Midlertidig kode</th><th>Handling</th></tr>`;
        users.forEach(u => {
            html += `<tr>
                <td>${u.brugernavn || '-'}</td>
                <td>
                    <select onchange="window.updateRole('${u.id}', this.value)">
                        <option value="medarbejder"${u.rolle==='medarbejder'?' selected':''}>Medarbejder</option>
                        <option value="teamleder"${u.rolle==='teamleder'?' selected':''}>Teamleder</option>
                    </select>
                </td>
                <td>
                    <select onchange="window.moveUser('${u.id}', this.value)">
                        <option value="">Ingen</option>
                        ${teams.map(t => `<option value="${t.id}"${u.team_id===t.id?' selected':''}>${t.navn}</option>`).join('')}
                    </select>
                </td>
                <td>${u.aktiv ? 'Aktiv' : 'Inaktiv'}</td>
                <td>${u.temp_password || '-'}</td>
                <td>
                    <button onclick="window.toggleActive('${u.id}', ${!u.aktiv})">${u.aktiv ? 'Deaktivér' : 'Aktivér'}</button>
                    <button onclick="window.deleteUser('${u.id}')" style="color:red;">Slet</button>
                </td>
            </tr>`;
        });
        html += '</table></div>';
        document.getElementById('userTable').innerHTML = html;
        // Opret ny gruppe/team
        document.getElementById('createTeamForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = document.getElementById('teamName').value.trim();
            if (!name) return;
            const { error } = await _supabase.from('TEAMS').insert({ navn: name });
            if (error) {
                document.getElementById('teamCreateResult').textContent = 'Fejl: ' + error.message;
            } else {
                document.getElementById('teamCreateResult').textContent = 'Gruppe/team oprettet!';
                document.getElementById('teamName').value = '';
                loadTeamsDropdown();
            }
        });

        // Slet bruger
        window.deleteUser = async function(id) {
            if (!confirm('Er du sikker på, at du vil slette denne bruger?')) return;
            // Slet fra auth og fra PROFILES_EMPLOYEE
            await _supabase.from('PROFILES_EMPLOYEE').delete().eq('id', id);
            // Bemærk: Sletning fra auth kræver service role key og bør gøres via backend for fuld sikkerhed
            loadUsers();
        }
    }

    // Globale window-funktioner til inline events
    window.updateRole = async function(id, rolle) {
        await _supabase.from('PROFILES_EMPLOYEE').update({ rolle }).eq('id', id);
        loadUsers();
    }
    window.moveUser = async function(id, team_id) {
        await _supabase.from('PROFILES_EMPLOYEE').update({ team_id: team_id || null }).eq('id', id);
        loadUsers();
    }
    window.toggleActive = async function(id, aktiv) {
        await _supabase.from('PROFILES_EMPLOYEE').update({ aktiv }).eq('id', id);
        loadUsers();
    }

    // Menu funktionalitet
    const menuBtn = document.getElementById('menuBtn');
    const sideMenu = document.getElementById('sideMenu');
    menuBtn.addEventListener('click', function() {
        sideMenu.classList.toggle('open');
    });
    document.addEventListener('click', function(e) {
        if (!sideMenu.contains(e.target) && !menuBtn.contains(e.target)) {
            sideMenu.classList.remove('open');
        }
    });

    // Init
    loadUsers();
    </script>
</body>
</html>