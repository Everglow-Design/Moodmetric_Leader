<!DOCTYPE html>
<html lang="da">
<head>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <meta charset="UTF-8">
    <title>Segmentering / Teams</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="dashboard-container" style="position: relative;">
        <button class="menu-btn" id="menuBtn" aria-label="√Öbn menu">‚ò∞</button>
        <nav class="side-menu" id="sideMenu">
            <a href="ledelse.html">Dashboard</a>
            <a href="analyse.html">Analyse</a>
            <a href="segmentering.html">Segmentering</a>
            <a href="advarsler.html">Advarsler</a>
            <a href="brugere.html">Bruger-adgang</a>
            <a href="rapporter.html">Rapporter</a>
            <a href="index.html">Log ud</a>
        </nav>
        <h1>Segmentering / Teams</h1>
        <p>Afdelinger, teams, sammenligning (uden persondata).</p>
        <div id="segmentering-indhold">Her kommer segmenterings- og teamdata.</div>
            <section class="section" style="margin-top: 24px;">
                <h2>Opret team/afdeling</h2>
                <form id="createTeamForm" style="margin-bottom: 18px;">
                    <input type="text" id="teamName" placeholder="Teamnavn" required style="padding: 6px;">
                    <input type="text" id="teamGroup" placeholder="Gruppe/afdeling" required style="padding: 6px;">
                    <button type="submit">Opret</button>
                </form>
                <div id="teamList"></div>
            </section>
            <section class="section">
                <h2>Tildel medarbejdere til team</h2>
                <form id="assignForm" style="margin-bottom: 18px;">
                    <select id="teamSelect"></select>
                    <input type="text" id="employeeName" placeholder="Medarbejdernavn" required style="padding: 6px;">
                    <button type="submit">Tildel</button>
                </form>
                <div id="teamMembers"></div>
            </section>
            <section class="section">
                <h2>Aggregerede data pr. team</h2>
                <div id="teamData"></div>
                <button id="refreshTeamData" style="margin-top:10px;">Opdater data</button>
            </section>
            <section class="section">
                <h2>Sammenlign teams</h2>
                <form id="compareTeamsForm" style="margin-bottom: 18px;">
                    <select id="compareTeam1"></select>
                    <select id="compareTeam2"></select>
                    <button type="submit">Sammenlign</button>
                </form>
                <div id="compareResult"></div>
            </section>
    </div>
    <script>
        // Supabase setup
        const SUPABASE_URL = 'https://rwksvrxfsjfdikckwmzq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3a3N2cnhmc2pmZGlrY2t3bXpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczOTY5MTksImV4cCI6MjA4Mjk3MjkxOX0.rddfbx0API_R62uLWJdM5QCMmqIwc-9b6XpgfNsbsOk';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Hent og vis aggregerede data pr. team
        async function loadTeamAggregates() {
            const { data: teams } = await _supabase.from('TEAMS').select('*');
            const teamDataDiv = document.getElementById('teamData');
            teamDataDiv.innerHTML = '';
            if (teams && teams.length) {
                for (const team of teams) {
                    // Hent alle medlemmer
                    const { data: members } = await _supabase.from('TEAM_MEMBERS').select('navn').eq('team_id', team.id);
                    if (!members || !members.length) continue;
                    // Hent alle check-ins for medlemmer
                    const memberNames = members.map(m => m.navn);
                    if (!memberNames.length) continue;
                    const { data: checkins } = await _supabase
                        .from('CHECKINS_EMPLOYEE')
                        .select('stressniveau, user_id, dato')
                        .in('user_id', memberNames);
                    // Beregn gennemsnit
                    const stressValues = checkins ? checkins.map(c => c.stressniveau).filter(v => typeof v === 'number') : [];
                    const avg = stressValues.length ? (stressValues.reduce((a, b) => a + b, 0) / stressValues.length).toFixed(2) : 'Ingen data';
                    // Udvikling over tid (seneste 7 dage)
                    const today = new Date();
                    const days = [];
                    const values = [];
                    for (let i = 0; i < 7; i++) {
                        const d = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 6 + i);
                        const dStr = d.toISOString().slice(0, 10);
                        days.push(dStr);
                        const dayCheckins = checkins ? checkins.filter(c => c.dato && c.dato.slice(0, 10) === dStr) : [];
                        const dayAvg = dayCheckins.length ? (dayCheckins.reduce((sum, c) => sum + c.stressniveau, 0) / dayCheckins.length).toFixed(2) : null;
                        values.push(dayAvg);
                    }
                    // Stabilitet: beregn standardafvigelse
                    let stability = 'Ingen data';
                    if (stressValues.length > 1) {
                        const mean = stressValues.reduce((a, b) => a + b, 0) / stressValues.length;
                        const variance = stressValues.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / (stressValues.length - 1);
                        stability = Math.sqrt(variance).toFixed(2);
                    }
                    // Vis kun aggregerede tal
                    const teamDiv = document.createElement('div');
                    teamDiv.style.marginBottom = '18px';
                    teamDiv.innerHTML = `<strong>${team.navn} (${team.gruppe || 'Uden gruppe'})</strong><br>
                        Gennemsnitligt trivselstal: <b>${avg}</b><br>
                        Stabilitet (standardafvigelse): <b>${stability}</b><br>
                        Udvikling over tid (seneste 7 dage): <br>
                        <span style='font-size:0.95em;'>${days.map((d, i) => `${d}: ${values[i] ?? '-'}`).join('<br>')}</span>`;
                    teamDataDiv.appendChild(teamDiv);
                }
            } else {
                teamDataDiv.innerHTML = '<em>Ingen teams oprettet</em>';
            }
        }

        document.getElementById('refreshTeamData').addEventListener('click', loadTeamAggregates);
        // Auto-load ved start
        loadTeamAggregates();

                // Load teams and members
                async function loadTeams() {
                    const { data: teams } = await _supabase.from('TEAMS').select('*').order('id');
                        const teamList = document.getElementById('teamList'); 
                        const teamSelect = document.getElementById('teamSelect'); 
                        const compareTeam1 = document.getElementById('compareTeam1'); 
                        const compareTeam2 = document.getElementById('compareTeam2'); 
                    teamList.innerHTML = '';
                    teamSelect.innerHTML = '';
                    compareTeam1.innerHTML = '';
                    compareTeam2.innerHTML = '';
                    if (teams && teams.length) {
                        // Grupp√©r teams efter gruppe
                        const grupper = {};
                        teams.forEach(team => {
                            if (!grupper[team.gruppe]) grupper[team.gruppe] = [];
                            grupper[team.gruppe].push(team);
                        });
                        Object.keys(grupper).forEach(gruppeNavn => {
                            const gruppeDiv = document.createElement('div');
                            gruppeDiv.style.marginBottom = '10px';
                            gruppeDiv.innerHTML = `<strong>${gruppeNavn || 'Uden gruppe'}</strong><br>`;
                            grupper[gruppeNavn].forEach(team => {
                                const li = document.createElement('div');
                                li.style.display = 'flex';
                                li.style.alignItems = 'center';
                                li.style.justifyContent = 'space-between';
                                li.style.gap = '8px';
                                li.textContent = team.navn;
                                // Tilf√∏j slet-knap
                                const delBtn = document.createElement('button');
                                delBtn.textContent = 'Slet';
                                delBtn.style.marginLeft = '12px';
                                delBtn.style.color = 'white';
                                delBtn.style.background = '#e74c3c';
                                delBtn.style.border = 'none';
                                delBtn.style.borderRadius = '5px';
                                delBtn.style.padding = '2px 10px';
                                delBtn.style.cursor = 'pointer';
                                delBtn.onclick = function() { window.deleteTeam(team.id, team.navn); };
                                li.appendChild(delBtn);
                                gruppeDiv.appendChild(li);
                                        // Slet team-funktion
                                        window.deleteTeam = async function(teamId, teamNavn) {
                                            if (!confirm('Er du sikker p√•, at du vil slette teamet "' + teamNavn + '"?')) return;
                                            // Slet team-medlemmer f√∏rst (for at undg√• FK constraint)
                                            await _supabase.from('TEAM_MEMBERS').delete().eq('team_id', teamId);
                                            // Slet selve teamet
                                            await _supabase.from('TEAMS').delete().eq('id', teamId);
                                            // Opdater visning
                                            loadTeams();
                                            loadTeamAggregates();
                                        };
                                // Dropdowns
                                const opt1 = document.createElement('option');
                                opt1.value = team.id;
                                opt1.textContent = team.navn;
                                teamSelect.appendChild(opt1);
                                const opt2 = document.createElement('option');
                                opt2.value = team.id;
                                opt2.textContent = team.navn;
                                compareTeam1.appendChild(opt2.cloneNode(true));
                                compareTeam2.appendChild(opt2.cloneNode(true));
                            });
                            teamList.appendChild(gruppeDiv);
                        });
                    }
                    loadTeamMembers();
                }

                // Sammenlign teams - flyt logik ind i submit-handler
                document.getElementById('compareTeamsForm').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const id1 = document.getElementById('compareTeam1').value;
                    const id2 = document.getElementById('compareTeam2').value;
                    if (!id1 || !id2 || id1 === id2) {
                        document.getElementById('compareResult').innerHTML = '<em>V√¶lg to forskellige teams</em>';
                        return;
                    }
                    // Hent teams
                    const { data: teams } = await _supabase.from('TEAMS').select('*').in('id', [id1, id2]);
                    // Hent medlemmer
                    const teamMembers = {};
                    for (const team of teams) {
                        const { data: members } = await _supabase.from('TEAM_MEMBERS').select('navn').eq('team_id', team.id);
                        teamMembers[team.id] = members ? members.map(m => m.navn) : [];
                    }
                    // Hent check-ins og beregn n√∏gletal
                    const teamStats = [];
                    for (const team of teams) {
                        const memberNames = teamMembers[team.id];
                        let avg = 'Ingen data', stability = 'Ingen data', trend = 'Ingen data', status = '‚ö™';
                        if (memberNames.length) {
                            const { data: checkins } = await _supabase
                                .from('CHECKINS_EMPLOYEE')
                                .select('stressniveau, user_id, dato')
                                .in('user_id', memberNames);
                            const stressValues = checkins ? checkins.map(c => c.stressniveau).filter(v => typeof v === 'number') : [];
                            if (stressValues.length) {
                                const mean = stressValues.reduce((a, b) => a + b, 0) / stressValues.length;
                                avg = mean.toFixed(2);
                                // Status emoji
                                status = mean < 3.5 ? 'üî¥' : mean < 5.5 ? 'üü°' : 'üü¢';
                                // Stabilitet
                                if (stressValues.length > 1) {
                                    const variance = stressValues.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / (stressValues.length - 1);
                                    stability = Math.sqrt(variance).toFixed(2);
                                }
                                // Trend (seneste 7 dage)
                                const today = new Date();
                                const days = [];
                                const values = [];
                                for (let i = 0; i < 7; i++) {
                                    const d = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 6 + i);
                                    const dStr = d.toISOString().slice(0, 10);
                                    days.push(dStr);
                                    const dayCheckins = checkins ? checkins.filter(c => c.dato && c.dato.slice(0, 10) === dStr) : [];
                                    const dayAvg = dayCheckins.length ? (dayCheckins.reduce((sum, c) => sum + c.stressniveau, 0) / dayCheckins.length) : null;
                                    values.push(dayAvg);
                                }
                                // Trend tekst
                                const validValues = values.filter(v => v !== null);
                                if (validValues.length > 2) {
                                    const first = validValues[0];
                                    const last = validValues[validValues.length - 1];
                                    if (last > first) trend = 'Stigende';
                                    else if (last < first) trend = 'Faldende';
                                    else trend = 'Stabil';
                                }
                            }
                        }
                        teamStats.push({
                            navn: team.navn,
                            status,
                            avg,
                            trend,
                            stability
                        });
                    }
                    // Vis sammenligning
                    document.getElementById('compareResult').innerHTML = `
                        <table style="width:100%;max-width:500px;border-collapse:collapse;margin-top:12px;">
                          <tr style="background:#f4f6fb;"><th>Team</th><th>Status</th><th>Niveau</th><th>Trend</th><th>Stabilitet</th></tr>
                          ${teamStats.map(t => `<tr><td>${t.navn}</td><td style='font-size:1.3em;'>${t.status}</td><td>${t.avg}</td><td>${t.trend}</td><td>${t.stability}</td></tr>`).join('')}
                        </table>
                    `;
                });
                // Opret team
                document.getElementById('createTeamForm').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const name = document.getElementById('teamName').value.trim();
                    const group = document.getElementById('teamGroup').value.trim();
                    if (!name || !group) return;
                    await _supabase.from('TEAMS').insert([{ navn: name, gruppe: group }]);
                    document.getElementById('teamName').value = '';
                    document.getElementById('teamGroup').value = '';
                    loadTeams();
                });

                // Tildel medarbejder til team
                document.getElementById('assignForm').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const teamId = document.getElementById('teamSelect').value;
                    const employee = document.getElementById('employeeName').value.trim();
                    if (!teamId || !employee) return;
                    await _supabase.from('TEAM_MEMBERS').insert([{ team_id: teamId, navn: employee }]);
                    document.getElementById('employeeName').value = '';
                    loadTeamMembers();
                });

                // Vis medlemmer for valgt team
                async function loadTeamMembers() {
                    const teamId = document.getElementById('teamSelect').value;
                    if (!teamId) return;
                    const { data: members } = await _supabase.from('TEAM_MEMBERS').select('*').eq('team_id', teamId);
                    const teamMembers = document.getElementById('teamMembers');
                    teamMembers.innerHTML = '<strong>Medlemmer:</strong><br>';
                    if (members && members.length) {
                        members.forEach(m => {
                            teamMembers.innerHTML += m.navn + '<br>';
                        });
                    } else {
                        teamMembers.innerHTML += '<em>Ingen medlemmer</em>';
                    }
                }

                document.getElementById('teamSelect').addEventListener('change', loadTeamMembers);

                // Init
                loadTeams();
        // Menu funktionalitet
        const menuBtn = document.getElementById('menuBtn');
        const sideMenu = document.getElementById('sideMenu');
        menuBtn.addEventListener('click', function() {
            sideMenu.classList.toggle('open');
        });
        document.addEventListener('click', function(e) {
            if (!sideMenu.contains(e.target) && !menuBtn.contains(e.target)) {
                sideMenu.classList.remove('open');
            }
        });
    </script>
</body>
</html>